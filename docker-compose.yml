services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TOKEN}
    depends_on:
      - caddy
    networks:
      - proxy
      - plausible_proxy
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  mariadb:
    container_name: mariadb
    image: mariadb:11.3.2
    platform: linux/arm64
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./bash/init-maria-db.sh:/docker-entrypoint-initdb.d/init-maria-db.sh
      - ./mariadb_backup/backup.sh:/backup.sh
      - ./mariadb_backup/backups:/backups
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PW}
      DB_READ_PW: ${DB_READ_PW}
      DB_FPP_PW: ${DB_FPP_PW}
    restart: unless-stopped
    healthcheck:
      interval: 10s
      retries: 5
      timeout: 10s
      test:
        [
          "CMD",
          "healthcheck.sh",
          "--su-mysql",
          "--connect",
          "--innodb_initialized",
        ]
    networks:
      - db
    ports:
      - "33306:3306"
    security_opt:
      - no-new-privileges:true
    mem_limit: 2g
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

  fpp-server:
    container_name: fpp-server
    platform: linux/arm64
    restart: unless-stopped
    build:
      context: ./fpp_server/
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: INFO
      FPP_SERVER_SECRET: ${FPP_SERVER_SECRET}
      SENTRY_DSN: ${FPP_SERVER_SENTRY_DSN}
    volumes:
      - fpp_server_data:/usr/src/app
    networks:
      - proxy
    security_opt:
      - no-new-privileges:true

  fpp-analytics:
    container_name: fpp-analytics
    platform: linux/arm64
    restart: unless-stopped
    build:
      context: ./fpp_analytics/
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: INFO
      ANALYTICS_SECRET_TOKEN: ${ANALYTICS_SECRET_TOKEN}
      BEA_BASE_URL: ${BEA_BASE_URL}
      BEA_SECRET_KEY: ${BEA_SECRET_KEY}
      FPP_ANALYTICS_SENTRY_DSN: ${FPP_ANALYTICS_SENTRY_DSN}
      SENTRY_ENVIRONMENT: production
      DATA_DIR: /app/data
    depends_on:
      - fpp-analytics-updater
    networks:
      - proxy
    volumes:
      - fpp_analytics_data:/app/data:ro
    security_opt:
      - no-new-privileges:true
    mem_limit: 1g

  fpp-analytics-updater:
    container_name: fpp-analytics-updater
    platform: linux/arm64
    restart: unless-stopped
    build:
      context: ./fpp_analytics/
      dockerfile: Dockerfile
    entrypoint: ["sh", "-c", "while true; do python update_readmodel.py; sleep 600; done"]
    environment:
      LOG_LEVEL: INFO
      DB_HOST: mariadb
      DB_USERNAME: fpp
      DB_PORT: 3306
      DB_PASSWORD: ${DB_FPP_PW}
      DATA_DIR: /app/data
      FPP_ANALYTICS_SENTRY_DSN: ${FPP_ANALYTICS_SENTRY_DSN}
      SENTRY_ENVIRONMENT: production
      UPTIMEKUMA_PUSH_URL: ${UPTIMEKUMA_PUSH_URL}
    depends_on:
      - mariadb
    networks:
      - db
    volumes:
      - fpp_analytics_data:/app/data
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"

  bun-email-api:
    container_name: bun-email-api
    platform: linux/arm64
    restart: unless-stopped
    build:
      context: ./bun_email_api/
      dockerfile: Dockerfile
    environment:
      LOG_LEVEL: INFO
      BEA_RESEND_API_KEY: ${BEA_RESEND_API_KEY}
      BEA_RECEIVER_EMAIL: ${BEA_RECEIVER_EMAIL}
      BEA_SECRET_KEY: ${BEA_SECRET_KEY}
    volumes:
      - bun_email_api_data:/usr/src/app
    networks:
      - proxy
    security_opt:
      - no-new-privileges:true

  caddy:
    build:
      context: ./caddy
      dockerfile: Dockerfile
    container_name: caddy
    platform: linux/arm64
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ./photo_gallery:/var/www/photos:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN}
    networks:
      - proxy
      - plausible_proxy
    security_opt:
      - no-new-privileges:true

  snow-finder:
    container_name: snow-finder
    platform: linux/arm64
    restart: unless-stopped
    build:
      context: ./snow_finder/
      dockerfile: Dockerfile
    volumes:
      - snow_finder_data:/usr/src/app
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      BASE_URL: ${SNOW_FINDER_BASE_URL}
    networks:
      - proxy
    security_opt:
      - no-new-privileges:true

  beszel-agent:
    image: henrygd/beszel-agent
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./beszel_agent_data:/var/lib/beszel-agent
      # monitor other disks / partitions by mounting a folder in /extra-filesystems
      # - /mnt/disk/.beszel:/extra-filesystems/sda1:ro
    environment:
      LISTEN: 45876
      KEY: ${BESZEL_AGENT_KEY}
      TOKEN: ${BESZEL_AGENT_TOKEN}
      HUB_URL: https://beszel.jkrumm.com
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  dozzle-agent:
    image: amir20/dozzle:latest
    container_name: dozzle-agent
    restart: unless-stopped
    command: agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    secrets:
      - source: cert
        target: /dozzle_cert.pem
      - source: key
        target: /dozzle_key.pem
    ports:
      - "100.82.157.104:7007:7007"
    security_opt:
      - no-new-privileges:true
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: nickfedor/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_LABEL_ENABLE: "true"
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_SCHEDULE: "0 0 4 * * *"
      WATCHTOWER_INCLUDE_RESTARTING: "true"
    security_opt:
      - no-new-privileges:true

secrets:
  cert:
    file: ./cert.pem
  key:
    file: ./key.pem

volumes:
  mariadb_data:
  fpp_server_data:
  fpp_analytics_data:
  snow_finder_data:
  caddy_data:
  caddy_config:
  bun_email_api_data:

networks:
  proxy:
  db:
  plausible_proxy:
    external: true
